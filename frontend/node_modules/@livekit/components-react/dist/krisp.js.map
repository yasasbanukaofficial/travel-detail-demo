{"version":3,"file":"krisp.js","sources":["../src/hooks/cloud/krisp/useKrispNoiseFilter.ts"],"sourcesContent":["import * as React from 'react';\nimport { LocalAudioTrack } from 'livekit-client';\nimport { log } from '@livekit/components-core';\nimport type { KrispNoiseFilterProcessor, NoiseFilterOptions } from '@livekit/krisp-noise-filter';\nimport type { TrackReferenceOrPlaceholder } from '@livekit/components-core';\nimport { useLocalParticipant } from '../../..';\n\n/**\n * @beta\n */\nexport interface useKrispNoiseFilterOptions {\n  /**\n   * The track reference to use for the noise filter (defaults: local microphone track)\n   */\n  trackRef?: TrackReferenceOrPlaceholder;\n  /**\n   * @internal\n   */\n  filterOptions?: NoiseFilterOptions;\n}\n\n/**\n * Enable the Krisp enhanced noise cancellation feature for local audio tracks.\n *\n * Defaults to the localParticipant's microphone track publication, but you can override this behavior by passing in a different track reference.\n *\n * @package \\@livekit/components-react/krisp\n * @remarks This filter requires that you install the `@livekit/krisp-noise-filter` package and is supported only on {@link https://cloud.livekit.io | LiveKit Cloud}.\n * @beta\n * @example\n * ```tsx\n * const krisp = useKrispNoiseFilter();\n * return <input\n *   type=\"checkbox\"\n *   onChange={(ev) => krisp.setNoiseFilterEnabled(ev.target.checked)}\n *   checked={krisp.isNoiseFilterEnabled}\n *   disabled={krisp.isNoiseFilterPending}\n * />\n * ```\n * @returns Use `setIsNoiseFilterEnabled` to enable/disable the noise filter.\n */\nexport function useKrispNoiseFilter(options: useKrispNoiseFilterOptions = {}) {\n  const [shouldEnable, setShouldEnable] = React.useState(false);\n  const [isNoiseFilterPending, setIsNoiseFilterPending] = React.useState(false);\n  const [isNoiseFilterEnabled, setIsNoiseFilterEnabled] = React.useState(false);\n  let micPublication = useLocalParticipant().microphoneTrack;\n  const [krispProcessor, setKrispProcessor] = React.useState<\n    KrispNoiseFilterProcessor | undefined\n  >();\n  if (options.trackRef) {\n    micPublication = options.trackRef.publication;\n  }\n\n  const setNoiseFilterEnabled = React.useCallback(async (enable: boolean) => {\n    if (enable) {\n      const { KrispNoiseFilter, isKrispNoiseFilterSupported } = await import(\n        '@livekit/krisp-noise-filter'\n      );\n\n      if (!isKrispNoiseFilterSupported()) {\n        log.warn('LiveKit-Krisp noise filter is not supported in this browser');\n        return;\n      }\n      if (!krispProcessor) {\n        setKrispProcessor(KrispNoiseFilter(options.filterOptions));\n      }\n    }\n    setShouldEnable((prev) => {\n      if (prev !== enable) {\n        setIsNoiseFilterPending(true);\n      }\n      return enable;\n    });\n  }, []);\n\n  React.useEffect(() => {\n    if (micPublication && micPublication.track instanceof LocalAudioTrack && krispProcessor) {\n      const currentProcessor = micPublication.track.getProcessor();\n      if (currentProcessor && currentProcessor.name === 'livekit-noise-filter') {\n        setIsNoiseFilterPending(true);\n        (currentProcessor as KrispNoiseFilterProcessor).setEnabled(shouldEnable).finally(() => {\n          setIsNoiseFilterPending(false);\n          setIsNoiseFilterEnabled(shouldEnable);\n        });\n      } else if (!currentProcessor && shouldEnable) {\n        setIsNoiseFilterPending(true);\n        micPublication?.track\n          ?.setProcessor(krispProcessor)\n          .then(() => krispProcessor.setEnabled(shouldEnable))\n          .then(() => {\n            setIsNoiseFilterEnabled(true);\n          })\n          .catch((e: any) => {\n            setIsNoiseFilterEnabled(false);\n            log.error('Krisp hook: error enabling filter', e);\n          })\n          .finally(() => {\n            setIsNoiseFilterPending(false);\n          });\n      }\n    }\n  }, [shouldEnable, micPublication, krispProcessor]);\n\n  return {\n    setNoiseFilterEnabled,\n    isNoiseFilterEnabled,\n    isNoiseFilterPending,\n    processor: krispProcessor,\n  };\n}\n"],"names":["useKrispNoiseFilter","options","shouldEnable","setShouldEnable","React","isNoiseFilterPending","setIsNoiseFilterPending","isNoiseFilterEnabled","setIsNoiseFilterEnabled","micPublication","useLocalParticipant","krispProcessor","setKrispProcessor","setNoiseFilterEnabled","enable","KrispNoiseFilter","isKrispNoiseFilterSupported","log","prev","LocalAudioTrack","currentProcessor","_a","e"],"mappings":"44BAyCgB,SAAAA,EAAoBC,EAAsC,GAAI,CAC5E,KAAM,CAACC,EAAcC,CAAe,EAAIC,EAAM,SAAS,EAAK,EACtD,CAACC,EAAsBC,CAAuB,EAAIF,EAAM,SAAS,EAAK,EACtE,CAACG,EAAsBC,CAAuB,EAAIJ,EAAM,SAAS,EAAK,EACxE,IAAAK,EAAiBC,wBAAsB,gBAC3C,KAAM,CAACC,EAAgBC,CAAiB,EAAIR,EAAM,SAEhD,EACEH,EAAQ,WACVQ,EAAiBR,EAAQ,SAAS,aAGpC,MAAMY,EAAwBT,EAAM,YAAY,MAAOU,GAAoB,CACzE,GAAIA,EAAQ,CACV,KAAM,CAAE,iBAAAC,EAAkB,4BAAAC,GAAgC,KAAM,QAC9D,6BACF,EAEI,GAAA,CAACA,IAA+B,CAClCC,EAAA,IAAI,KAAK,6DAA6D,EACtE,MAAA,CAEGN,GACeC,EAAAG,EAAiBd,EAAQ,aAAa,CAAC,CAC3D,CAEFE,EAAiBe,IACXA,IAASJ,GACXR,EAAwB,EAAI,EAEvBQ,EACR,CACH,EAAG,EAAE,EAELV,OAAAA,EAAM,UAAU,IAAM,OACpB,GAAIK,GAAkBA,EAAe,iBAAiBU,EAAAA,iBAAmBR,EAAgB,CACjF,MAAAS,EAAmBX,EAAe,MAAM,aAAa,EACvDW,GAAoBA,EAAiB,OAAS,wBAChDd,EAAwB,EAAI,EAC3Bc,EAA+C,WAAWlB,CAAY,EAAE,QAAQ,IAAM,CACrFI,EAAwB,EAAK,EAC7BE,EAAwBN,CAAY,CAAA,CACrC,GACQ,CAACkB,GAAoBlB,IAC9BI,EAAwB,EAAI,GAC5Be,EAAAZ,GAAA,YAAAA,EAAgB,QAAhB,MAAAY,EACI,aAAaV,GACd,KAAK,IAAMA,EAAe,WAAWT,CAAY,GACjD,KAAK,IAAM,CACVM,EAAwB,EAAI,CAAA,GAE7B,MAAOc,GAAW,CACjBd,EAAwB,EAAK,EACzBS,MAAA,MAAM,oCAAqCK,CAAC,CAAA,GAEjD,QAAQ,IAAM,CACbhB,EAAwB,EAAK,CAAA,GAEnC,CAED,EAAA,CAACJ,EAAcO,EAAgBE,CAAc,CAAC,EAE1C,CACL,sBAAAE,EACA,qBAAAN,EACA,qBAAAF,EACA,UAAWM,CACb,CACF"}