"use strict";const F=require("react"),r=require("./shared-BVVr9jJ4.js"),u=require("./shared-DXC9VBzT.js"),c=require("livekit-client");function q(e){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const n in e)if(n!=="default"){const s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:()=>e[n]})}}return t.default=e,Object.freeze(t)}const i=q(F);function U(e){const t=r.useEnsureRoom(e),n=i.useCallback(async()=>{await t.startAudio()},[t]),s=i.useMemo(()=>r.roomAudioPlaybackAllowedObservable(t),[t]),{canPlayAudio:o}=u.useObservableState(s,{canPlayAudio:t.canPlaybackAudio});return{canPlayAudio:o,startAudio:n}}function $(e){const{state:t,dispatch:n}=u.useLayoutContext().pin;return{buttonProps:i.useMemo(()=>{const{className:o}=r.setupClearPinButton();return u.mergeProps(e,{className:o,disabled:!(t!=null&&t.length),onClick:()=>{n&&n({msg:"clear_pin"})}})},[e,n,t])}}function z(e,t){const n=typeof e=="function"?e:t,s=typeof e=="string"?e:void 0,o=r.useRoomContext(),{send:a,messageObservable:p,isSendingObservable:b}=i.useMemo(()=>r.setupDataMessageHandler(o,s,n),[o,s,n]),d=u.useObservableState(p,void 0),m=u.useObservableState(b,!1);return{message:d,send:a,isSending:m}}const K={connect:!0,audio:!1,video:!1};function V(e){const{token:t,serverUrl:n,options:s,room:o,connectOptions:a,connect:p,audio:b,video:d,screen:m,onConnected:g,onDisconnected:l,onError:S,onMediaDeviceFailure:k,onEncryptionError:T,simulateParticipants:y,...C}={...K,...e};s&&o&&r.log.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[f,L]=i.useState(),R=i.useRef(p);i.useEffect(()=>{L(o??new c.Room(s))},[o,JSON.stringify(s,u.roomOptionsStringifyReplacer)]);const j=i.useMemo(()=>{const{className:P}=r.setupLiveKitRoom();return u.mergeProps(C,{className:P})},[C]);return i.useEffect(()=>{if(!f)return;const P=()=>{const v=f.localParticipant;r.log.debug("trying to publish local tracks"),Promise.all([v.setMicrophoneEnabled(!!b,typeof b!="boolean"?b:void 0),v.setCameraEnabled(!!d,typeof d!="boolean"?d:void 0),v.setScreenShareEnabled(!!m,typeof m!="boolean"?m:void 0)]).catch(O=>{r.log.warn(O),S==null||S(O)})},M=(v,O)=>{const J=c.MediaDeviceFailure.getFailure(v);k==null||k(J,O)},A=v=>{T==null||T(v)},x=v=>{l==null||l(v)},D=()=>{g==null||g()};return f.on(c.RoomEvent.SignalConnected,P).on(c.RoomEvent.MediaDevicesError,M).on(c.RoomEvent.EncryptionError,A).on(c.RoomEvent.Disconnected,x).on(c.RoomEvent.Connected,D),()=>{f.off(c.RoomEvent.SignalConnected,P).off(c.RoomEvent.MediaDevicesError,M).off(c.RoomEvent.EncryptionError,A).off(c.RoomEvent.Disconnected,x).off(c.RoomEvent.Connected,D)}},[f,b,d,m,S,T,k,g,l]),i.useEffect(()=>{if(f){if(y){f.simulateParticipants({participants:{count:y},publish:{audio:!0,useRealTracks:!0}});return}if(p){if(R.current=!0,r.log.debug("connecting"),!t){r.log.debug("no token yet");return}if(!n){r.log.warn("no livekit url provided"),S==null||S(Error("no livekit url provided"));return}f.connect(n,t,a).catch(P=>{r.log.warn(P),R.current===!0&&(S==null||S(P))})}else r.log.debug("disconnecting because connect is false"),R.current=!1,f.disconnect()}},[p,t,JSON.stringify(a),f,S,n,y]),i.useEffect(()=>{if(f)return()=>{r.log.info("disconnecting on onmount"),f.disconnect()}},[f]),{room:f,htmlProps:j}}function G(e={}){let t=u.useMaybeParticipantContext();e.participant&&(t=e.participant);const n=i.useMemo(()=>r.participantInfoObserver(t),[t]),{identity:s,name:o,metadata:a}=u.useObservableState(n,{name:t==null?void 0:t.name,identity:t==null?void 0:t.identity,metadata:t==null?void 0:t.metadata});return{identity:s,name:o,metadata:a}}function W(e={}){const t=u.useEnsureParticipant(e.participant),n=i.useMemo(()=>r.participantPermissionObserver(t),[t]);return u.useObservableState(n,t.permissions)}function h(e={}){const t=r.useEnsureRoom(e.room),[n,s]=i.useState([]);return i.useEffect(()=>{const o=r.connectedParticipantsObserver(t,{additionalRoomEvents:e.updateOnlyOn}).subscribe(s);return()=>o.unsubscribe()},[t,JSON.stringify(e.updateOnlyOn)]),n}function H(e={}){const t=h(e),{localParticipant:n}=r.useLocalParticipant(e);return i.useMemo(()=>[n,...t],[n,t])}function Q(e,t={}){const n=r.useRoomContext(),[s]=i.useState(t.updateOnlyOn),o=i.useMemo(()=>typeof e=="string"?r.connectedParticipantObserver(n,e,{additionalEvents:s}):r.participantByIdentifierObserver(n,e,{additionalEvents:s}),[n,JSON.stringify(e),s]),[a,p]=i.useState({p:void 0});return i.useEffect(()=>{const b=o.subscribe(d=>p({p:d}));return()=>b.unsubscribe()},[o]),a.p}function X(e={}){const t=r.useEnsureRoom(e.room),n=i.useMemo(()=>r.roomInfoObserver(t),[t]),{name:s,metadata:o}=u.useObservableState(n,{name:t.name,metadata:t.metadata});return{name:s,metadata:o}}function I(){const e=r.useRoomContext(),t=i.useMemo(()=>r.activeSpeakerObserver(e),[e]);return u.useObservableState(t,e.activeSpeakers)}function Y(e){const[t,n]=i.useState(r.sortParticipants(e)),s=I();return i.useEffect(()=>{n(r.sortParticipants(e))},[s,e]),t}function Z(e,t,n={}){const[s,o]=i.useState(void 0);return i.useEffect(()=>{var p;if(e===void 0)throw Error("token endpoint needs to be defined");if(((p=n.userInfo)==null?void 0:p.identity)===void 0)return;(async()=>{r.log.debug("fetching token");const b=new URLSearchParams({...n.userInfo,roomName:t}),d=await fetch(`${e}?${b.toString()}`);if(!d.ok){r.log.error(`Could not fetch token. Server responded with status ${d.status}: ${d.statusText}`);return}const{accessToken:m}=await d.json();o(m)})()},[e,t,JSON.stringify(n)]),s}function ee(e){const[t,n]=i.useState(r.getTrackByIdentifier(e)),{trackObserver:s}=i.useMemo(()=>r.setupMediaTrack(e),[e.participant.sid??e.participant.identity,e.source]);return i.useEffect(()=>{const o=s.subscribe(a=>{n(a)});return()=>o==null?void 0:o.unsubscribe()},[s]),{participant:e.participant,source:e.source??c.Track.Source.Unknown,publication:t}}function te(e,t){const n=u.useEnsureParticipant(t);return ee({name:e,participant:n})}function E(e,t){const n=r.useRoomContext(),s=u.useMaybeParticipantContext(),o=t?n.getParticipantByIdentity(t):s,a=i.useMemo(()=>o?r.participantTracksObservable(o,{sources:e}):void 0,[o==null?void 0:o.sid,o==null?void 0:o.identity,JSON.stringify(e)]);return u.useObservableState(a,[])}function ne(e){var n,s,o;const t=i.useMemo(()=>{var a;return(a=e==null?void 0:e.publication)!=null&&a.track?r.trackSyncTimeObserver(e==null?void 0:e.publication.track):void 0},[(n=e==null?void 0:e.publication)==null?void 0:n.track]);return u.useObservableState(t,{timestamp:Date.now(),rtpTimestamp:(o=(s=e==null?void 0:e.publication)==null?void 0:s.track)==null?void 0:o.rtpTimestamp})}const se={bufferSize:100};function N(e,t){const n={...se,...t},[s,o]=i.useState([]),a=ne(e),p=b=>{var d;(d=n.onTranscription)==null||d.call(n,b),o(m=>r.dedupeSegments(m,b.map(g=>r.addMediaTimestampToTranscription(g,a)),n.bufferSize))};return i.useEffect(()=>{if(!(e!=null&&e.publication))return;const b=r.trackTranscriptionObserver(e.publication).subscribe(d=>{p(...d)});return()=>{b.unsubscribe()}},[e&&r.getTrackReferenceId(e),p]),{segments:s}}function _(e={}){const t=u.useMaybeParticipantContext(),n=e.participant??t,s=i.useMemo(()=>r.participantAttributesObserver(n),[n]);return u.useObservableState(s,{attributes:n==null?void 0:n.attributes})}function oe(e,t={}){const n=u.useEnsureParticipant(t.participant),[s,o]=i.useState(n.attributes[e]);return i.useEffect(()=>{if(!n)return;const a=r.participantAttributesObserver(n).subscribe(p=>{p.changed[e]!==void 0&&o(p.attributes[e])});return()=>{a.unsubscribe()}},[n,e]),s}const w="lk.agent.state";function re(){const e=h(),t=e.find(l=>l.kind===c.ParticipantKind.AGENT&&!("lk.publish_on_behalf"in l.attributes)),n=e.find(l=>l.kind===c.ParticipantKind.AGENT&&l.attributes["lk.publish_on_behalf"]===(t==null?void 0:t.identity)),s=E([c.Track.Source.Microphone,c.Track.Source.Camera],t==null?void 0:t.identity),o=E([c.Track.Source.Microphone,c.Track.Source.Camera],n==null?void 0:n.identity),a=s.find(l=>l.source===c.Track.Source.Microphone)??o.find(l=>l.source===c.Track.Source.Microphone),p=s.find(l=>l.source===c.Track.Source.Camera)??o.find(l=>l.source===c.Track.Source.Camera),{segments:b}=N(a),d=u.useConnectionState(),{attributes:m}=_({participant:t}),g=i.useMemo(()=>d===c.ConnectionState.Disconnected?"disconnected":d===c.ConnectionState.Connecting||!t||!(m!=null&&m[w])?"connecting":m[w],[m,t,d]);return{agent:t,state:g,audioTrack:a,videoTrack:p,agentTranscriptions:b,agentAttributes:m}}function ie(e){const t=r.useEnsureRoom(e),n=u.useConnectionState(t),s=i.useMemo(()=>r.recordingStatusObservable(t),[t,n]);return u.useObservableState(s,t.isRecording)}function B(e){const t=r.useRoomContext(),s=u.useConnectionState(t)===c.ConnectionState.Disconnected,o=i.useMemo(()=>r.setupTextStream(t,e),[t,e]),a=s?void 0:o;return{textStreams:u.useObservableState(a,[])}}function ae(e){const{participantIdentities:t,trackSids:n}=e??{},{textStreams:s}=B(r.DataTopic.TRANSCRIPTION);return i.useMemo(()=>s.filter(a=>t?t.includes(a.participantInfo.identity):!0).filter(a=>{var p;return n?n.includes(((p=a.streamInfo.attributes)==null?void 0:p["lk.transcribed_track_id"])??""):!0}),[s,t,n])}exports.useAudioPlayback=U;exports.useClearPinButton=$;exports.useDataChannel=z;exports.useIsRecording=ie;exports.useLiveKitRoom=V;exports.useParticipantAttribute=oe;exports.useParticipantAttributes=_;exports.useParticipantInfo=G;exports.useParticipantPermissions=W;exports.useParticipantTracks=E;exports.useParticipants=H;exports.useRemoteParticipant=Q;exports.useRemoteParticipants=h;exports.useRoomInfo=X;exports.useSortedParticipants=Y;exports.useSpeakingParticipants=I;exports.useTextStream=B;exports.useToken=Z;exports.useTrackByName=te;exports.useTrackTranscription=N;exports.useTranscriptions=ae;exports.useVoiceAssistant=re;
//# sourceMappingURL=shared-DimS3cEB.js.map
